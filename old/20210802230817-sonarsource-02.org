:PROPERTIES:
:ID:        07478c80-22eb-4762-88a7-cc2031b58519
:ROAM_REFS: https://twitter.com/SonarSource/status/1393100930124554242
:END:
#+title: sonarsource-02
#+filetags: :vcdb:java:

* Description

* Code
#+begin_src java
public class IndexServlet extends HttpServlet {
    private String referer;
    private ExportIcalManager exportManager;
    private void exportIcal(HttpServletResponse res, String sessionId)
            throws ServletException, IOException {
	res.addHeader("Access-Control-Allow-Origin", referer);
        res.setContentType("text/plain");
        ExportIcalManager exportManager = new ExportIcalManager(sessionId);
        String filePath = exportManager.exportIcalAgendaForSynchro();
        OutputStream os = res.getOutputStream();
        FileInputStream fs = new FileInputStream(filePath);
        int i;
        while (((i = fs.read()) != -1)) { os.write(i); }
        os.close();
    }

    protected void doPost(HttpServletRequest req, HttpServletResponse res)
            throws ServletException, IOException {
        HttpSession session = req.getSession();
	referer = req.getParameter("referer");
	exportIcal(res, req.getRequestedSessionId());
    }
}

#+end_src

* Solution
#+begin_src java
public class IndexServlet extends HttpServlet {
    private String referer;
    private ExportIcalManager exportManager;
    private void exportIcal(HttpServletResponse res, String sessionId)
            throws ServletException, IOException {
	res.addHeader("Access-Control-Allow-Origin", referer);       // 2) referer is used to allow arbitrary origins
        res.setContentType("text/plain");
        ExportIcalManager exportManager = new ExportIcalManager(sessionId);
        String filePath = exportManager.exportIcalAgendaForSynchro();
        OutputStream os = res.getOutputStream();
        FileInputStream fs = new FileInputStream(filePath);
        int i;
        while (((i = fs.read()) != -1)) { os.write(i); }
        os.close();
    }

    protected void doPost(HttpServletRequest req, HttpServletResponse res)
            throws ServletException, IOException {
        HttpSession session = req.getSession();
	referer = req.getParameter("referer");                       // 1) referer is user input
	exportIcal(res, req.getRequestedSessionId());
    }
}

#+end_src