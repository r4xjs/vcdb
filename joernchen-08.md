---

title: joernchen-08
author: raxjs
tags: [ruby]

---

Ruby on rails login and password reset. It is quite hard to find ;-)

<!--more-->
{{< reference src="https://code-audit-training.gitlab.io/" >}}

# Code
{{< code language="ruby"  title="Challenge" expand="Show" collapse="Hide" isCollapsed="false" >}}
# Try to become "admin" on http://gettheadmin.herokuapp.com/
# Vector borrowed from real-world code ;)


# config/routes.rb:

  root 'login#login'
  post 'login' => 'login#login'
  get 'reset/:token' => 'login#password_reset'

# app/controllers/login_controller.rb

class LoginController < ApplicationController
  def login
    if request.post?
      user = User.where(login: params[:login]).first
      if !user.nil?
        if params[:password] == user.password
           render :text => "censored"
        end
        render :text => "Wrong Password"
        return
      end
    else
      render :template => "login/form"
    end
  end
  def password_reset
    @user = User.where(token: params[:token]).first
    if @user
      session[params[:token]] = @user.id
    else
      user_id = session[params[:token]]
      @user = User.find(user_id) if user_id
    end
    if !@user
      render :text => "no way!"
      return
    elsif params[:password] && @user && params[:password].length > 6
      @user.password = params[:password]
        if @user.save
          render :text => "password changed ;)"
          return
        end
    end
    render :text => "error saving password!"
  end

end

{{< /code >}}

# Solution
{{< code language="ruby" highlight="19,20,32,33,38-43,51,52" title="Solution" expand="Show" collapse="Hide" isCollapsed="true" >}}
# Try to become "admin" on http://gettheadmin.herokuapp.com/
# Vector borrowed from real-world code ;)


# config/routes.rb:

  root 'login#login'
  post 'login' => 'login#login'
  get 'reset/:token' => 'login#password_reset'

# app/controllers/login_controller.rb

class LoginController < ApplicationController
  def login
    if request.post?
      user = User.where(login: params[:login]).first
      if !user.nil?
        # 1) this looks like as if the clear text
        #    password is stored in the db
        if params[:password] == user.password
           render :text => "censored"
        end
        render :text => "Wrong Password"
        return
      end
    else
      render :template => "login/form"
    end
  end
  def password_reset
    # 2) this looks like as if the token is never removed
    #    which would mean that the token could be used more then once
    @user = User.where(token: params[:token]).first
    if @user
      session[params[:token]] = @user.id
    else
      # 3) params[:token] is fully under user control and not sanitized.
      #    This means that we can query arbitrary keys out of the session.
      #    When params[:token] = '_csrf_token' we will query the current
      #    csrf token that was generated by rails.
      #    When the csrf token starts with "1XXXXXXX" then we will
      #    find the user with uid 1 which is probably the admin (@user = admin user)
      user_id = session[params[:token]]
      @user = User.find(user_id) if user_id
    end
    if !@user
      render :text => "no way!"
      return
    elsif params[:password] && @user && params[:password].length > 6
      # 4) If the problem described in 3) is exploited we will reset
      #    the admin users password here. Source of the solution [1]
      @user.password = params[:password]
        if @user.save
          render :text => "password changed ;)"
          return
        end
    end
    render :text => "error saving password!"
  end

end

# [1] https://www.akitaonrails.com/2014/08/28/small-bite-session-injection-challenge
{{< /code >}}
